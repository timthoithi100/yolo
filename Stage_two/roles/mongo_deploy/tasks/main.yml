---
- name: Copy docker-compose.yaml to the EC2 instance
  ansible.builtin.copy:
    src: "{{ lookup('env', 'PWD') }}/docker-compose.yaml"
    dest: /home/ubuntu/yolo/docker-compose.yaml
    owner: ubuntu
    group: ubuntu
    mode: '0644'
  become: yes

- name: Ensure Docker network 'app-net' exists (if not created by docker-compose implicitly)
  community.docker.docker_network:
    name: app-net
    driver: bridge
    attachable: yes
    ipam_config:
      - subnet: 172.20.0.0/16
        ip_range: 172.20.0.0/16
  become: yes
  when: false

- name: Start MongoDB container using docker-compose
  community.docker.docker_compose_v2:
    project_src: /home/ubuntu/yolo
      - docker-compose.yaml
    services:
      - app-mongo
    state: present
    build: no
  become: yes

- name: Wait for MongoDB service to be healthy
  community.docker.docker_compose_v2:
    project_src: /home/ubuntu/yolo
    files:
      - docker-compose.yaml
    services:
      - app-mongo
    state: present
    pull: no
    recreate: no
    wait: yes
    wait_timeout: 180
  become: yes
